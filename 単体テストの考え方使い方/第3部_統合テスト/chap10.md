## データベースに対するテスト

- この章で扱うこと
  - データベースをテストするのに必要な事前準備
  - データベースのテストに関するベストプラクティス
  - テストデータのライフサイクル
  - テストでのデータベースのトランザクション管理

### データベースをテストするのに必要な事前準備

- <font color=red>統合テストでは、ファイルシステムやデータベースなどの<b>管理下にある依存</b>をそのまま使うようにすべきであり、その事前準備として以下の作業が必要である</font>
  - スキーマ(テーブルやインデックス、ビューやストアドルーチンなど)をGitなどのソースコード管理システムを用いて管理する
  - 開発者ごとに個別のDBインスタンスを用意する
  - DBに対する変更を本番環境に反映する際は移行ベース(↔︎状態ベース)を用いる

#### ソースコード管理システムを用いたスキーマの管理

- <font color=red>開発者だけが使うDBインスタンスを用いてDBの変更することは<b>アンチパターン</b>である。<b><u>すべての変更履歴を残すため</u>にGitなどのソースコード管理ツールを用いてスキーマの変更を記録する</b>。</font>
- スキーマをソースコード管理ツールで残さないことで発生する問題は以下の2つ
  1. **変更の履歴が辿れない**: スキーマが過去にどうなっていたのかを知る方法がなくなる。<u>バグ再現のためにも変更履歴は必要</u>である。
  2. **真実が1つではなくなる**: <u>その時点でのDBのスキーマを1つにする(**複数の情報源を持たない**)</u>ためにソースコード管理ツールは重要である。
- アプリを適切に機能させるために事前に必要なデータを**参照データ**とよび、<u>参照データはINSERT文の形でソースコードとして管理したほうが良い</u>。**通常データと参照データが混合で存在するテーブルについては区別するフラグを用意することで対応**する。

#### 開発者ごとに個別のDBインスタンスを用意する

- <font color=red>開発者自身のPC単位でDBインスタンスを用意することで以下の効果が期待できる。</font>
  1. 後方互換不可などの作業により他の開発者の作業時間を止めることがない。
  2. 複数実行による、お互いのテストの影響がない。
  3. テストに必要な時間を最小化できる。

#### 本番環境DBへの変更の反映: 移行ベース vs. 状態ベース

- <font color=red>初回リリース(新規開発)において本番環境への適用は状態ベースでも良いが、<b>2回目以降(派生開発)の本番環境への適用はドメインを含む開発がほとんとであり、かつデータモーションが重要になることから移行ベースでの適用が必要がある</b>。</font>
- 本番環境へのDBの反映方法は状態ベースと移行ベースの2つがある。
  - **状態ベース**: <u>DBの状態を明確にすることに重きを置いた反映方法</u>。開発用DBを用意し、開発用DBに対して変更を行い、開発用DBと本番用DBを比較して変更内容を反映させる方法。
  - **移行ベース**: <u>移行手順を明確にすることに重きを置いた反映方法</u>。開発者自身がSQLスクリプトを作成して、本番用DBに変更内容を反映させる方法。
- <u>状態ベースを用いると、DBがどの様な状態になるのかが明確になる。</u>これにより、**マージ競合の対処がしやすくなる**というメリットがある。
- <u>移行ベースを用いると、どの様に移行するのかが明確になる。</u>これにより、**データモーション(既存データの形状を変え、新スキーマにそのデータを適合させること)の取り組みがしやすくなる**というメリットがある。

<table>
    <caption>状態ベースと移行ベースの比較</caption>
	<tbody>
		<tr>
			<th></th>
			<th>DBの状態</th>
			<th>移行手順</th>
		</tr>
		<tr>
			<th>状態ベース</th>
			<td>明確になる<br>(マージ競合の対処が容易)</td>
			<td>隠れる</td>
		</tr>
		<tr>
			<th>移行ベース</th>
			<td>隠れる</td>
			<td>明確になる<br>(データモーションの取り組みが容易)</td>
		</tr>
	</tbody>
</table>

### データベーストランザクションの管理

- 

### テストデータのライフサイクル

- 

### テストコードの再利用

- 

### データベースを使ったテストに関するよくある疑問

- 

### 結論

- 
